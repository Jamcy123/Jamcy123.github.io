# IP

第三层 网络层作用：**实现主机与主机之间的通信，也叫点对点（end to end）通信**。

>  网络层和数据链路层有什么关系？

MAC 的作用是实现「直连」的两个设备之间通信，而 IP 则负责「没有直连」的两个网络之间进行通信传输。

源 IP 地址和目标 IP 地址在传输过程中是不会变化的，只有源 MAC 地址和目标 MAC 一直在变化。



## IP 地址分类

IP 地址（IPv4 地址）由 `32` 位正整数来表示，IP 地址在计算机是以二进制的方式处理的。

<img src="C:\Users\Jamcy\AppData\Roaming\Typora\typora-user-images\image-20220314234646384.png" alt="image-20220314234646384" style="zoom:80%;" />

> A、B、C分类地址最大主机个数如何计算？

看主机号位数： **$2^{主机号位数} - 2$**



* 2：主机号全 1 和全 0 是特殊的IP

![image-20220314234929932](C:\Users\Jamcy\AppData\Roaming\Typora\typora-user-images\image-20220314234929932.png)

* 主机号全为 1 指定某个网络下的所有主机，用于广播
* 主机号为全 0 指定某个网络



> 广播地址用于什么？

广播地址用于在**同一个链路中相互连接的主机之间发送数据包**。

* 在本网络内广播的叫做本地广播。
* 在不同网络之间的广播叫做直接广播。

> 什么是D、E类地址？

D类、E类地址是没有主机号的，所以不可用于主机IP，D类常被用于**多播**，E类是预留的分类，暂时未使用。

> 多播地址用于什么？

多播用于**将包发送给特定组内的所有主机**。

由于广播无法穿透路由，若想给其他网段发送同样的包，就可以使用能够穿透路由的多播。

> IP 分类的缺点

缺点一

同一网络下没有地址层次，即这种没有地址层次划分的功能，缺少地址的灵活性。

缺点二

A、B、C类地址的主机数量不能很好的与现实网络匹配。



## 无分类地址 CIDR

不再有分类地址的概念，32bit的 IP 地址被划分为两部分，前面是**网络号**，后面是**主机号**。

**子网掩码**，掩码的意思就是掩盖掉主机号，剩余的就是网络号。

将子网掩码和 IP 地址按位计算 AND，就可得到网络号。

> 为什么要分离网络号和主机号？

因为两台计算机要通讯，首先要**判断是否处于同一个广播域内**，即**网络地址是否相同**。如果网络地址相同，表明接受方在本网络上，那么可以把数据包直接发送到目标主机。

> 怎么进行子网划分？

通过子网掩码。

* 未做子网划分的 IP 地址：网络地址+主机地址
* 做子网划分后的 IP 地址：网络地址 + ( 子网网络地址 + 子网主机地址 )

## IPv6

> IPv6 亮点

* 可分配的地址变多了
* 可自动配置，即使没有 DHCP 服务器也可以实现自动分配 IP 地址
* IPv6 包头包首部长度采用固定的值 `40` 字节，去掉了包头校验和，简化了首部结构，减轻了路由器负担，提高了传输性能
* IPv6 有应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能，大大提升了安全性

> IPv6地址的标识方法

IPv6 地址长度是 128 位，是以每 16 位作为一组，每组用冒号「:」隔开。

如果出现连续的 0 时还可以将这些 0 省略，并用两个冒号「::」隔开。但是，一个 IP 地址中只允许出现一次两个连续的冒号。

> IPv6 地址的结构

通过 IP 地址前几位标识 IP 地址的种类。

IPv6 的地址主要有以下类型地址：

* 单播地址，用于一对一的通信
* 组播地址，用于一对多的通信
* 任播地址，用于通信最近的节点，最近的节点是由路由协议决定
* 没有广播地址

> IPv6 单播地址类型

对于一对一通信的 IPv6 地址，主要划分了三类单播地址，每类地址的有效范围都不同

* 在同一链路单播通信，不经过路由器，可以使用**链路本地单播地址**，IPv4 没有此类型
* 在内网里单播通信，可以使用**唯一本地地址**，相当于 IPv4 的私有 IP 
* 在互联网通信，可以使用**全局单播地址**，相当于 IPv4 的公有 IP

### IPv4 首部 与 IPv6 首部的对比

![image-20220315201040788](C:\Users\Jamcy\AppData\Roaming\Typora\typora-user-images\image-20220315201040788.png)

IPv6 相比 IPv4 的首部改进：

* **取消了首部检验和字段**。因为在数据链路层和传输层都会校验，因此 IPv6 直接取消了 IP 的校验。
* **取消了分片**/**重新组装相关字段**。分片与重组是耗时的过程，IPv6 不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
* **取消选项字段**。选项字段不再是标准 IP 首部的一部分了，但它并没有消失，而是可能出现在 IPv6 首部种的「下一个首部」指出的位置上。删除该选项字段使得 IPv6 的首部成为固定长度的 `40` 字节。



## IP 协议

# 输入网址到网页显示，期间发生了什么？

### 1、查找DNS缓存

1. 先查找浏览器DNS缓存，看是否存放目标网络的IP地址
2. 如果不在浏览器缓存，则浏览器将对操作系统发起系统调用，查询操作系统本地缓存
3. 如果不在操作系统本地缓存，则浏览器会查询与之相连的路由器缓存
4. 如果不在路由器缓存，则浏览器会检查ISP【本地通信服务商】缓存

若以上四步均没有查询到目标网络的IP地址，则发起DNS查询。

### 2、发起DNS查询

判断DNS服务器和我们的主机是否在同一子网内

1. 在同一子网，则采用ARP地址解析协议对DNS服务器进行ARP查询
2. 不在同一子网，则采用ARP地址解析协议对默认网关进行查询

若此时还是查询不到IP地址，则根据拿到DNS服务器或者默认网关的IP地址，继续进行DNS请求

使用53端口先向本地DNS服务器发送UDP请求包，此处一般使用UDP协议（如果响应包太大，则使用TCP协议）

**没有查询到IP地址**

则它会发送一个递归查询请求，一层一层向高层DNS服务器查询，直到查询到IP地址，则将结果返回

【解释：DNS是分布式域名服务器，每台服务器只维护一部分IP地址到网络地址的映射，没有任何一台服务器能够维持全部的映射关系】

### 3、封装TCP数据包

拿到IP地址后，根据URL中的端口可知端口号【HTTP：80；HTTPS：443】，一般会先尝试建立HTTP链接。

**准备TCP数据包**：

**步骤**：

1. 将应用层传递下来的实际数据，在传输层添加TCP首部
2. 将传输层传下来的数据在网络层添加IP首部
3. 将网络层传输下来的数据，在数据链路层添加以太网首部，并在传输介质中进行传输

### 4、浏览器与目标服务器建立TCP连接

经过上述DNS和ARP查询流程后，浏览器会收到目标服务器的IP和MAC地址，然后经过三次握手后建立TCP连接。

1. 使用HTTP协议

   浏览器发送请求到服务器，如果使用的是HTTP协议，则服务器之间返回结果

2. 使用HTTPS协议

   如果不是HTTP协议，则服务器会返回一个以3开头的重定向消息，告诉浏览器使用的是HTTPS，IP没变，端口号变成443；完成四次挥手；

   重新建立TCP连接，将端口号修改为443，同时沟通号双方使用的认证算法、加密和解密算法，在此过程中也会检查对方的CA安全证书，采用SSL加密技术进行传输数据

### 5、浏览器发送HTTP/HTTPS请求到web服务器

**主要使用两种请求方式**：

1. 浏览器发送get请求，要求目标服务器提供输入的网页
2. 浏览器发送post请求，表示填写的是表单

### 6、服务器处理请求并返回一个响应

服务器会从浏览器接受请求并将其传递给请求处理程序并响应

### 7、服务器发回一个HTTP响应

一般响应包含：请求的网页以及状态码，压缩类型，如何缓存的页面，设置的cookie

### 8、浏览器显示HTML页面

1. 渲染HTML骨架；涉及到Ajax技术
2. 检查HTML标记并发送GET请求以获取网页上的其他元素【图像、CSS样式、JS文件等】，该静态文件一般由浏览器缓存，并再次访问，不用重新请求。
3. 最后会看到请求色彩斑斓的网页

